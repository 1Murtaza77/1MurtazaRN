<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Hydraulic Design – Free Version</title>
  <link rel="stylesheet" hrefist/leaflet.css
  <style>
    #map { height: 80vh; width: 100%; }
    #panel { padding: 8px; font-family: system-ui; }
    pre { background: #f7f7f8; border: 1px solid #ddd; padding: 8px; max-height: 30vh; overflow: auto; }
    button { margin-right: 8px; }
  </style>
</head>
<body>
  <div id="panel">
    <button id="clear">Clear</button>
    <button id="downloadInp">Download INP</button>
    <span id="count"></span>
    <pre id="log"></pre>
  </div>
  <div id="map"></div>

  https://unpkg.com/leaflet/dist/leaflet.js</script>
  <script>
    // ← Ganti dengan URL awam dari Sel D (cloudflared) di Colab:
    const CLOUD_API_BASE = "https://pansophically-interradial-jimena.ngrok-free.dev";

    let map = L.map('map').setView([13.7563, 100.5018], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let nodes = [];
    map.on('click', async (e) => {
      const lat = e.latlng.lat, lng = e.latlng.lng;
      const elevResp = await fetch(`${CLOUD_API_BASE}/api/elev?lat=${lat}&lng=${lng}`);
      const elevData = await elevResp.json();
      const elev = elevData.elevation;
      const id = `N${nodes.length+1}`;
      nodes.push({id, lat, lng, elev});
      L.marker([lat, lng]).addTo(map).bindPopup(`${id}<br>Elev: ${elev?.toFixed(2)} m`);
      updateLog();
    });

    function updateLog(){
      document.getElementById("log").textContent = JSON.stringify(nodes, null, 2);
      document.getElementById("count").textContent = `Nodes: ${nodes.length}`;
    }

    document.getElementById("clear").onclick = ()=>{ nodes=[]; updateLog(); };

    document.getElementById("downloadInp").onclick = async ()=>{
      const r = await fetch(`${CLOUD_API_BASE}/api/build_inp`, {
        method:"POST", headers:{'Content-Type':'application/json'},
        body: JSON.stringify({nodes})
      });
      const out = await r.json();
      const blob = new Blob([out.inp], {type:"text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "network.inp";
      a.click();
    };
  </script>
</body>
</html>
